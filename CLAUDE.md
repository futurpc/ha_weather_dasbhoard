# Home Assistant Weather Dashboard - Project Context

## Hardware
- **Board**: ELECROW CrowPanel 7.0" Basic Series (EK9716BD3 display driver)
- **MCU**: ESP32-S3-WROOM-1-N4R8 (4MB Flash, 8MB PSRAM OPI)
- **Display**: 800x480 RGB parallel 16-bit bus, EK9716BD3 + EK73002ACGB driver ICs
- **Touch**: GT911 capacitive touch via I2C (SDA=19, SCL=20, INT=-1, RST=-1)
- **Backlight**: PWM on GPIO 2

## Build & Flash
- **Build system**: PlatformIO (installed at `/Users/grigoryr_mac/Library/Python/3.9/bin/pio`)
- **Build**: `pio run -d "<project_dir>"`
- **Flash**: `pio run -d "<project_dir>" -t upload`
- **Upload speed**: 460800 baud (921600 fails on this board)
- **Serial monitor**: 115200 baud (requires interactive terminal, can't run from Claude Code)
- **Flash size**: 4MB with `huge_app.csv` partition scheme (NOT 16MB - this is the Basic series N4R8)
- **IDE diagnostics**: All clang errors are false positives - PlatformIO resolves includes at build time

## Project Structure
```
src/
  main.cpp            - Entry point: setup/loop, LVGL timer for 30s HA polling
  config.h            - Entity IDs, display dimensions; includes secrets.h
  secrets.h           - WiFi creds, HA URL/token (gitignored, real credentials)
  secrets.h.example   - Template with placeholders (committed)
  display.h/.cpp      - LovyanGFX LGFX class + LVGL 8 display driver
  touch.h/.cpp        - GT911 touch + LVGL input driver
  wifi_manager.h/.cpp - WiFi connect with timeout, auto-reconnect every 10s
  ha_client.h/.cpp    - HA REST API client (ArduinoJson v7)
  ui.h/.cpp           - LVGL 8 UI layout + update + F/C toggle + light/dark theme toggle
  weather_icons.h     - HA condition string -> MDI icon mapping + font externs
  weather_font_40.c   - Custom MDI weather icon font 40px (generated by lv_font_conv)
  weather_font_24.c   - Custom MDI weather icon font 24px (generated by lv_font_conv)
include/
  lv_conf.h           - LVGL configuration (16-bit color, PSRAM, dark theme, fonts)
```

## Secrets / Credentials
- Sensitive data lives in `src/secrets.h` (gitignored) â€” WiFi SSID/password, HA base URL, HA token
- `src/secrets.h.example` is committed with placeholders
- `config.h` does `#include "secrets.h"` to pull in the defines

## Critical Technical Details

### Display (display.cpp)
- Uses **LovyanGFX** (NOT Arduino_GFX) - proven working with this exact board
- Member names MUST be `_panel_instance`/`_bus_instance` (NOT `_panel`/`_bus` - shadowing base class causes black screen)
- Must include platform-specific headers explicitly:
  - `<lgfx/v1/platforms/esp32s3/Panel_RGB.hpp>`
  - `<lgfx/v1/platforms/esp32s3/Bus_RGB.hpp>`
- Backlight: `Light_PWM` on GPIO 2 (required - without it screen stays dark)
- Panel framebuffer MUST be in PSRAM: `config_detail().use_psram = 1`
- Flush callback uses `tft.pushImage()` (NOT writePixels)
- RGB pin mapping: B(15,7,6,5,4) G(9,46,3,8,16,1) R(14,21,47,48,45)
- Sync: HSYNC=39, VSYNC=40, DE=41, PCLK=0 @15MHz

### LVGL (lv_conf.h)
- **LVGL 8.3.x** (NOT 9.x) - matches board's tested version
- `LV_COLOR_16_SWAP 1` - REQUIRED for correct colors on this RGB panel (0 causes green tint)
- Memory allocator uses PSRAM: `LV_MEM_CUSTOM_ALLOC ps_malloc`
- Dark theme enabled
- Fonts enabled: Montserrat 12, 14, 16, 20, 24, 32, 40

### Touch (touch.cpp)
- GT911 via TAMC_GT911 library
- INT and RST pins are -1 (board doesn't expose separate pins)
- MUST call `Wire.begin(SDA, SCL)` before `tp.begin()`
- MUST use `ROTATION_NORMAL` (value 3) - NOT 0 (ROTATION_LEFT swaps axes, breaks touch)
- MUST map coordinates: `map(raw, 800, 0, 0, 799)` and `map(raw, 480, 0, 0, 479)` to match Elecrow reference
- Touch callback feeds mapped coordinates to LVGL indev

### HA Client (ha_client.cpp)
- All data fetched as Celsius from HA REST API
- `fetch_temperature()` - for sensor entities (reads `state` directly)
- `fetch_climate_temperature()` - for climate entities like Tuya thermostats (reads `attributes.current_temperature`, NOT state)
- `fetch_forecast()` - dual approach:
  1. Try entity attributes first (older HA / some integrations)
  2. Fall back to `POST /api/services/weather/get_forecasts?return_response` (HA 2024.3+)
  3. Tries multiple response formats: `doc[entity]["forecast"]` and `doc["service_response"][entity]["forecast"]`

### UI (ui.cpp)
- **Theme system**: Runtime light/dark theme toggle (NOT compile-time #defines)
  - Colors provided via functions: `col_bg()`, `col_card()`, `col_text()`, `col_text_dim()`, `col_status_bar()`, `col_bar_track()`, `col_btn_bg()`, `col_btn_border()`
  - `dark_mode` static bool controls active theme
  - Dark theme: BG=0x0D1117, Card=0x21262D, Text=white, StatusBar=0x161B22
  - Light theme: BG=0xF0F2F5, Card=0xFFFFFF, Text=0x1F2328, StatusBar=0xD0D7DE
  - `apply_theme()` updates all widget colors at runtime
  - Static pointers to all containers: `obj_status_bar`, `obj_left_panel`, `obj_right_panel`, `obj_indoor_card`, `obj_outdoor_card`, `obj_sauna_card`, `obj_current_card`, forecast cards, etc.
- Status bar (36px): WiFi icon, status, "Home Weather" title, theme toggle (eye icon), F/C toggle button, "Updated: HH:MM"
- Left panel (220px): 3 cards (INDOOR, OUTDOOR, SAUNA) - title + 40px thermometer bar + temp label
- Right panel (580px): Current weather card (MDI icon 40px + condition + temp + wind + humidity) + 3-day forecast cards (MDI icon 24px)
- Loading overlay with spinner on initial connect
- F/C toggle: stores last_data, converts on display only, bars always use Celsius internally
- Theme toggle: eye icon button (LV_SYMBOL_EYE_CLOSE for dark, LV_SYMBOL_EYE_OPEN for light), calls `apply_theme()` + re-renders data via `ui_update()`
- Weather icons: Custom LVGL fonts from Material Design Icons (MDI webfont), generated via `lv_font_conv`
  - Codepoints: 0xF0590-0xF059E, 0xF067E, 0xF0F37
  - Font files: `weather_font_40.c` (40px) and `weather_font_24.c` (24px)

## HA Entity IDs (in config.h)
- Indoor temp: `sensor.h5071_50bc_temperature`
- Outdoor temp: `sensor.xiamoi_t3_thermometer_temperature`
- Weather: `weather.forecast_home`
- Sauna: `climate.itc_308_wifi_thermostat` (Tuya ITC-308-WIFI)

## Known Issues & Gotchas
- **Black screen**: Usually caused by missing PSRAM config, wrong member names, or missing backlight
- **Green tint**: `LV_COLOR_16_SWAP` must be 1
- **Touch not working**: Must use `ROTATION_NORMAL` + coordinate mapping + `Wire.begin()` before `tp.begin()`
- **Flash fails at 921600**: Use 460800 baud
- **16MB flash config on 4MB board**: Causes boot failure - use `huge_app.csv`
- **Forecast blank**: May need both entity attributes and service call approaches

## Regenerating Weather Icon Fonts
If icons need to be changed:
```bash
npm install -g lv_font_conv
curl -sL "https://github.com/Templarian/MaterialDesign-Webfont/raw/master/fonts/materialdesignicons-webfont.ttf" -o /tmp/mdi.ttf
lv_font_conv --font /tmp/mdi.ttf --bpp 4 --size 40 -r 0xF0590-0xF059E,0xF067E,0xF0F37 --format lvgl --no-compress -o src/weather_font_40.c --lv-include "lvgl.h"
lv_font_conv --font /tmp/mdi.ttf --bpp 4 --size 24 -r 0xF0590-0xF059E,0xF067E,0xF0F37 --format lvgl --no-compress -o src/weather_font_24.c --lv-include "lvgl.h"
```
